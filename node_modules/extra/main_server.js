const express = require("express");
const http = require("http");
const path=require("path")
var cors = require("cors"); 
const socketIo = require("socket.io");
const app = express();
const sessionStorage=require("sessionstorage")
const expressSession = require('express-socket.io-session'); // Integration library

const session=require("express-session")
const uuid=require("uuid")
const bodyParser = require("body-parser");
let z;
app.use(bodyParser.urlencoded({ extended: true }));

app.use(cors({
  origin: "*", // Update to match your frontend's origin
  methods: ["GET", "POST", "PUT"], // Correct case for "PUT"
  allowedHeaders: [
    "Content-Type",
    "X-Auth-Token",
    "Origin",
    "Authorization", // Corrected spelling
    "Access-Control-Allow-Headers",
    "Access-Control-Allow-Origin",
    "Accept",
    "X-Requested-With",
    "Access-Control-Request-Method",
    "Access-Control-Request-Headers",
  ],
  credentials: true, // Corrected key to lowercase
}));

let p=[];
/*
app.use(cors({
  origin:"*",
}));*/
app.use(express.static(path.join(__dirname)));
const server = http.createServer(app);
const io = socketIo(server);
console.log(__dirname);
const users = {};
const sessionMiddleware = session({
  secret: 'your-secret-key',
  resave: false,
  saveUninitialized: true
});

app.use(sessionMiddleware);

// Use the integration middleware
io.use(expressSession(sessionMiddleware));
io.on("connection", (socket) => {
  const q = socket.handshake.session.username;

  socket.on("new-user", (name) => {
    z=name.room
    console.log(q+"gbdgb")
    socket.join(z)
    users[socket.id] = q;
    console.log(name)
    p.push(q)
    console.log(p)
    socket.to(z).emit("userjoined",q);
    console.log("bjjfd")
    
  });

  socket.on("send", (message) => {
    socket.to(z).emit("receieve", { message: message, name: users[socket.id],room:z });
  });


  socket.on("disconnect", () => {
    console.log(z);
    const userName = users[socket.id];
    socket.leave(z);
    p=p.filter((item)=>
      (item!=userName)
    )
    console.log("exit", userName);
    socket.to(z).emit("dist", userName);
    console.log(p) // Notify other users in the room
});

});

server.listen(8001, () => {
  console.log("Server is running on port 8000");
});
